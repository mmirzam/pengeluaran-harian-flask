<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Aplikasi Pengeluaran Harian</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Gaya tambahan untuk pengalaman mobile yang lebih baik */
        .container { max-width: 600px; } /* Maksimum lebar diperkecil untuk fokus mobile */
        .form-label { font-weight: 600; margin-bottom: 0.2rem; }
    </style>
</head>
<body>
    <div class="container mt-4 mb-5">
        <h1 class="mb-4 text-center fs-3">Jajan Harian MMM ðŸš€</h1>

        <!-- START: TAMPILAN PESAN FLASH (Popup Notifikasi) -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="row mb-3">
                    <div class="col-12">
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        {% endwith %}
        <!-- END: POPUP NOTIFIKASI -->

        <div class="card p-3 shadow-sm">
            <h5 class="card-title fs-5 mb-3">Input Pengeluaran Baru</h5>
            <!-- DITAMBAHKAN: id="expenseForm" untuk JavaScript -->
            <form method="POST" action="/" id="expenseForm"> 
                <div class="row g-3">
                    
                    <div class="col-12">
                        <label for="nominal_formatted" class="form-label">Nominal (Rp)</label>
                        <!-- Input yang terlihat oleh pengguna, menggunakan type="text" untuk separator -->
                        <input type="text" class="form-control form-control-lg" id="nominal_formatted" 
                               oninput="formatNominal(this)"
                               placeholder="Pengeluaran (1k - 200k)..." required>

                        <!-- Input tersembunyi untuk mengirim nilai angka murni ke Flask -->
                        <input type="hidden" name="nominal" id="nominal_clean" 
                               min="{{ batas_nominal_min }}" 
                               max="{{ batas_nominal_max }}">
                    </div>

                    <div class="col-12">
                        <label class="form-label d-block">Metode Pembayaran</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="metode" id="metodeQris" value="qris" checked>
                            <label class="btn btn-outline-primary" for="metodeQris">QRIS</label>

                            <input type="radio" class="btn-check" name="metode" id="metodeCash" value="cash">
                            <label class="btn btn-outline-primary" for="metodeCash">Cash</label>
                        </div>
                    </div>

                    <div class="col-sm-6 col-12">
                        <label for="tanggal" class="form-label">Tanggal</label>
                        <input type="date" class="form-control" id="tanggal" name="tanggal"
                               value="{{ current_date }}" 
                               min="{{ batas_tanggal_min }}"
                               max="{{ batas_tanggal_max }}" 
                               required>
                    </div>
                    
                    <div class="col-sm-6 col-12">
                        <label for="catatan" class="form-label">Catatan (Opsional)</label>
                        <input type="text" class="form-control" id="catatan" name="catatan" placeholder="Makan siang, bensin, dll.">
                    </div>
                </div>
                <button type="submit" class="btn btn-success mt-4 w-100 btn-lg">âœ… SIMPAN PENGELUARAN</button>
            </form>
            {% if error %}
            <div class="alert alert-danger mt-3">{{ error }}</div>
            {% endif %}
        </div>
        
        <div class="mt-5 text-center">
            <button class="btn btn-info w-100" type="button" data-bs-toggle="collapse" data-bs-target="#chartCollapse" aria-expanded="false" aria-controls="chartCollapse">
                ðŸ“Š Tampilkan Analisis & Log Data
            </button>
        </div>

        <div class="collapse mt-4" id="chartCollapse">
               <div class="card p-3 shadow-sm">
                 <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation"><button class="nav-link active" id="mingguan-tab" data-bs-toggle="tab" data-bs-target="#mingguan" type="button" role="tab" aria-controls="mingguan" aria-selected="true">Mingguan</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" id="bulanan-tab" data-bs-toggle="tab" data-bs-target="#bulanan" type="button" role="tab" aria-controls="bulanan" aria-selected="false">Bulanan</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" id="log-tab" data-bs-toggle="tab" data-bs-target="#log" type="button" role="tab" aria-controls="log" aria-selected="false">Log Akhir</button></li>
                 </ul>

                 <div class="tab-content border-0 p-2" id="myTabContent">
                    <div class="tab-pane fade show active" id="mingguan" role="tabpanel" aria-labelledby="mingguan-tab"><canvas id="weeklyChart" class="mt-3"></canvas></div>

                    <div class="tab-pane fade" id="bulanan" role="tabpanel" aria-labelledby="bulanan-tab"><canvas id="monthlyChart" class="mt-3"></canvas></div>

                    <div class="tab-pane fade" id="log" role="tabpanel" aria-labelledby="log-tab">
                        <h6 class="mt-3">10 Pengeluaran Terakhir</h6>
                        <div class="table-responsive"> <table class="table table-sm table-striped">
                                 <thead><tr><th>Tgl</th><th>Metode</th><th>Nominal</th><th>Catatan</th></tr></thead>
                                 <tbody>
                                     {% for pengeluaran in pengeluaran_list %}
                                     <tr>
                                         <td>{{ pengeluaran.Tanggal }}</td> 
                                         <td>{{ pengeluaran.Metode.upper() }}</td>
                                         <td>Rp {{ "{:,.0f}".format(pengeluaran.Nominal) }}</td>
                                         <td>{{ pengeluaran.Catatan }}</td>
                                     </tr>
                                     {% endfor %}
                                 </tbody>
                            </table>
                        </div>
                    </div>
                 </div>
               </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Data dari Flask
        const weeklyLabels = {{ chart_labels_mingguan | tojson }};
        const weeklyData = {{ chart_data_mingguan | tojson }};
        const monthlyLabels = {{ chart_labels_bulanan | tojson }};
        const monthlyData = {{ chart_data_bulanan | tojson }};

        let weeklyChartInstance = null;
        let monthlyChartInstance = null;
        
        // --- FUNGSI SEPARATOR NOMINAL BARU ---
        
        function formatNominal(input) {
            // 1. Ambil nilai, hapus semua karakter non-digit (termasuk titik/koma sebelumnya)
            let value = input.value.replace(/\D/g, ''); 
            
            // 2. Batasi nilai antara min dan max yang dikirim dari Flask (Client-side validation)
            const nominalCleanInput = document.getElementById('nominal_clean');
            const min = parseInt(nominalCleanInput.min);
            const max = parseInt(nominalCleanInput.max);
            
            let numericValue = parseInt(value) || 0;

            if (numericValue > max) {
                value = String(max);
                numericValue = max;
            } 
            
            // 3. Format dengan separator ribuan (menggunakan . sebagai separator)
            let formattedValue = '';
            if (value.length > 0) {
                 // Menggunakan toLocaleString untuk memformat angka dengan separator (locale Indonesia)
                 formattedValue = numericValue.toLocaleString('id-ID');
            }
            
            // 4. Update input yang terlihat (formatted) dan input tersembunyi (clean)
            input.value = formattedValue;
            nominalCleanInput.value = numericValue;
        }

        // --- PENGIRIMAN FORM (Validasi Akhir Frontend) ---

        document.getElementById('expenseForm').addEventListener('submit', function(event) {
            const nominalCleanInput = document.getElementById('nominal_clean');
            const nominalValue = parseInt(nominalCleanInput.value) || 0;
            const min = parseInt(nominalCleanInput.min);
            const max = parseInt(nominalCleanInput.max);

            if (nominalValue < min || nominalValue > max) {
                event.preventDefault(); // Mencegah pengiriman formulir
                // Tampilkan pesan error custom
                alert(`Nominal harus antara Rp ${min.toLocaleString('id-ID')} dan Rp ${max.toLocaleString('id-ID')}.`);
            }
            // Jika nominal kosong (value=0), Flask akan menangani validasi
        });


        // --- FUNGSI CHART ---
        
        // Fungsi untuk menginisialisasi chart
        function initializeCharts() {
            // Chart Mingguan (Bar)
            if (!weeklyChartInstance) {
                weeklyChartInstance = new Chart(document.getElementById('weeklyChart'), {
                    type: 'bar',
                    data: {
                        labels: weeklyLabels,
                        datasets: [{ label: 'Pengeluaran (Rp)', data: weeklyData, backgroundColor: 'rgba(54, 162, 235, 0.6)' }]
                    },
                    options: { responsive: true, maintainAspectRatio: true, scales: { y: { beginAtZero: true } } }
                });
            }

            // Chart Bulanan (Line)
            if (!monthlyChartInstance) {
                monthlyChartInstance = new Chart(document.getElementById('monthlyChart'), {
                    type: 'line',
                    data: {
                        labels: monthlyLabels,
                        datasets: [{ label: 'Pengeluaran Bulanan (Rp)', data: monthlyData, backgroundColor: 'rgba(75, 192, 192, 0.6)', tension: 0.4 }]
                    },
                    options: { responsive: true, maintainAspectRatio: true, scales: { y: { beginAtZero: true } } }
                });
            }
        }
        
        // DENGARKAN ACARA SAAT COLLAPSE TERBUKA
        document.getElementById('chartCollapse').addEventListener('shown.bs.collapse', function () {
            initializeCharts();
        });
        
    </script>
</body>
</html>